# 作用域是什么

一套设计良好的规则来存储变量，并且之后可以方便地找到这些变量，这套规则被称为 **作用域**。

## 1.编译原理

> 通常将 JavaScript 归类为“动态”或“解释执行”语言，但事实上是一门编译语言。但与传统的编译语言不同，它不是提前编译的，编译结果也不能在分布式系统中进行移植。

### 1.1.传统编译语言的“编译”

在传统编译语言的流程中，程序中的一段源代码在执行之前会经历三个步骤，统称为“**编译**”。

- 分词/词法分析（Tokenizing/Lexing）
  - 这个过程会将字符组成的字符串分解成（对编程语言来说）有意义的代码块，这些代码块称为 **词法单元**（token）。

> 分词（tokenizing）和词法分析（Lexing）之间的区别是非常微妙、晦涩的，主要差异在于词法单元的识别是通过 *有状态* 还是 *无状态* 的方式进行的。简单来说，如果词法单元生成器在判断 a 是一个独立的词法单元还是其他词法单元的一部分时，调用的是有状态的解析规则，那么这个过程就被称为词法分析。

- 解析/语法分析（Parsing）
  - 这个过程是将词法单元流（数组）转换成一个由元素逐级嵌套所组成的代表程序语法结构的树，也就是“**抽象语法树**”（Abstract Syntax Tree，**AST**）。
>
- 代码生成
  - 将 AST 转换为可执行代码的过程。这个过程与语言、目标平台等有关。

### 1.2.JavaScript 编译

JavaScript 引擎在语法分析和代码生成阶段，会有特定的步骤来对运行性能进行优化，包括对冗余元素进行优化等。JavaScript 引擎为此引入了 JIT 来保障性能。

> 对于 JavaScript 来说，大部分情况下编译发生在代码执行前的几微秒（甚至更短）的时间内。

### 1.3.JIT

> [Hello, JIT World: The Joy of Simple JITs](https://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html)

## 2.作用域

简单说，作用域就是一套规则：管理引擎如何在当前作用域以及嵌套的作用域中根据【标识符】名称（即变量名称）进行变量查找。

### 2.1.LHS & RHS

查找过程中，【引擎】会采取两种查询策略：**LHS 查询** 和 **RHS 查询**。

简单说，变量出现在赋值操作左侧是进行 LHS 查询，若出现在右侧则进行 RHS 查询。更准确说，RHS 查询就是简单的查找某个变量以得其值，而 LHS 查询则是试图找到变量的容器本身。

区分 LHS 和 RHS 查询，是因为在变量没有声明的情况下，这两种查询行为是不同。

对于一个未声明的变量：

- RHS 查询在所有嵌套的作用域中都找不到该变量，引擎会抛出 `ReferenceError` 异常；
>
- LHS 查询在非“严格模式”下，会在【全局作用域】创建一个同名变量；而“严格模式”下，也会抛出 `ReferenceError` 异常；

```js
function foo() {
  return function bar() {
    a = 2;
    console.log(a); // 2
  }
}

foo()();

console.log(a, window.a); // 2 2
```

> 注意：函数 `foo` 被赋予实参后执行时，为了给形参 `a`（隐式）分配值，需要进行一次 LHS 查询。
> `ReferenceError` 表示作用域判别失败，`TypeError` 则表示作用域判别成功，但操作是非法或者不合理的。

### 2.2.作用域嵌套

作用域的嵌套，会形成一条“链”，也叫 “**作用域链**”。引擎也是通过这条作用域链，来（LHS 和 RHS）查询变量的。

> 注意，作用域的嵌套，是【严格包含】的。
